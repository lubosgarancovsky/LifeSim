(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))s(e);new MutationObserver(e=>{for(const h of e)if(h.type==="childList")for(const r of h.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function i(e){const h={};return e.integrity&&(h.integrity=e.integrity),e.referrerpolicy&&(h.referrerPolicy=e.referrerpolicy),e.crossorigin==="use-credentials"?h.credentials="include":e.crossorigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function s(e){if(e.ep)return;e.ep=!0;const h=i(e);fetch(e.href,h)}})();class B{constructor(t,i,s,e){this.posX=t,this.posY=i,this.surface=s,this.isEaten=!1,this.size=e*.2,this.growTimeout=null}draw(){this.isEaten||(this.surface.beginPath(),this.surface.fillStyle="rgb(1, 112, 6)",this.surface.arc(this.posX,this.posY,this.size,0,Math.PI*2),this.surface.fill())}update(){this.draw()}getEaten(){this.isEaten=!0,this.growTimeout=setTimeout(()=>{this.isEaten=!1,clearTimeout(this.growTimeout)},(Math.random()*(3e3-1e3)+1e3)*10)}}class b{constructor(t,i,s){this.settings=i,this.surface=t,this.GRID=s,this.WIDTH=i.width,this.HEIGHT=i.heigth,this.tileSize=Math.round(this.WIDTH/i.x),this.FOOD=[],this.createFood()}createFood(){var t=this.settings.food;for(let s of this.GRID){var i=Math.random();if(s.type==="ground"&&i<t){let e=s.posX+Math.round(s.size/2),h=s.posY+Math.round(s.size/2);this.FOOD.push(new B(e,h,this.surface,this.tileSize))}}}update(){this.FOOD.forEach(t=>t.update())}}class I{constructor(t,i,s,e,h){this.x=t,this.y=i,this.posX=t*s,this.posY=i*s,this.surface=e,this.size=s,this.type=h}draw(){this.surface.beginPath(),this.surface.fillStyle=this.type=="ground"?"rgb(3, 153, 2)":"rgb(2, 2, 181)",this.surface.fillRect(this.posX,this.posY,this.size,this.size)}}var _=perlinNoise3d=function(){for(var a=Math.floor(720),t=new Array(a),i=new Array(a),s=Math.PI/180,e=0;e<a;e++)t[e]=Math.sin(e*s*.5),i[e]=Math.cos(e*s*.5);var h=a;h>>=1;var r=function(){this.perlin_octaves=4,this.perlin_amp_falloff=.5,this.perlin=null};return r.prototype={noiseSeed:function(l){var n=function(){var w,c,p=4294967296;return{setSeed:function(u){c=w=(u==null?Math.random()*p:u)>>>0},getSeed:function(){return w},rand:function(){return(c=(1664525*c+1013904223)%p)/p}}}();n.setSeed(l),this.perlin=new Array(4096);for(var o=0;o<4096;o++)this.perlin[o]=n.rand();return this},get:function(l,n,o){if(n=n||0,o=o||0,this.perlin==null){this.perlin=new Array(4096);for(var w=0;w<4096;w++)this.perlin[w]=Math.random()}l<0&&(l=-l),n<0&&(n=-n),o<0&&(o=-o);for(var c,p,u,d,X,S=Math.floor(l),D=Math.floor(n),T=Math.floor(o),Y=l-S,O=n-D,k=o-T,R=0,W=.5,A=function(U){return .5*(1-i[Math.floor(U*h)%a])},q=0;q<this.perlin_octaves;q++){var f=S+(D<<4)+(T<<8);c=A(Y),p=A(O),u=this.perlin[4095&f],u+=c*(this.perlin[f+1&4095]-u),d=this.perlin[f+16&4095],u+=p*((d+=c*(this.perlin[f+16+1&4095]-d))-u),d=this.perlin[4095&(f+=256)],d+=c*(this.perlin[f+1&4095]-d),X=this.perlin[f+16&4095],d+=p*((X+=c*(this.perlin[f+16+1&4095]-X))-d),R+=(u+=A(k)*(d-u))*W,W*=this.perlin_amp_falloff,S<<=1,D<<=1,T<<=1,(Y*=2)>=1&&(S++,Y--),(O*=2)>=1&&(D++,O--),(k*=2)>=1&&(T++,k--)}return R}},r}(),$=_;class H{constructor(t,i){this.WIDTH=i.width,this.HEIGHT=i.height,this.surface=t,this.settings=i,this.countX=this.settings.x+1,this.tileSize=Math.round(this.WIDTH/this.countX),this.countY=Math.round(this.HEIGHT/this.tileSize)+1,this.GRID=[],this.WATER=[],this.createGrid()}createGrid(){const t=new $;for(var i=0;i<this.countX;i++)for(var s=0;s<this.countY;s++)if(t.get(i/10,s/10)<this.settings.water){let h=new I(i,s,this.tileSize,this.surface,"water");this.GRID.push(h),this.WATER.push(h)}else this.GRID.push(new I(i,s,this.tileSize,this.surface,"ground"))}update(){this.GRID.forEach(t=>t.draw())}}class v{constructor(t,i,s,e,h,r,l){this.posX=h.posX,this.posY=h.posY,this.gender=t,this.settings=i,this.surface=s,this.father=e,this.mother=h,this.type="Person",this.age=this.father.type=="Person"?0:Math.floor(Math.random()*(30-10)+10)+Math.random(),this.prevAge=this.father.type=="Person"?0:this.age-1,this.size=this.settings.width/this.settings.x*.2,this.adultSize=this.size*1.2,this.status="Wandering",this.data=r,this.population=l,this.gender=="M"?this.color="rgb(0, 206, 237)":this.color="rgb(227, 2, 77)",this.pregnantColor="rgb(84, 0, 0)",this.destX=0,this.destY=0,this.isWaiting=!1,this.isPregnant=!1,this.isAdult=!1,this.isAlive=!0,this.isSick=!1,this.isEating=!1,this.isDrinking=!1,this.isMating=!1,this.lastGotSick=0,this.randomDestination(),this.speed=(e.speed+h.speed)/2,this.viewrangeGene=(e.viewrangeGene+h.viewrangeGene)/2,this.hungerGene=(e.hungerGene+h.hungerGene)/2,this.thirstGene=(e.thirstGene+h.thirstGene)/2,this.matingGene=(e.matingGene+h.matingGene)/2,this.healthGene=(e.healthGene+h.healthGene)/2,this.viewrange=this.viewrangeGene*this.adultSize*10+this.adultSize*8,this.atractivity=Math.round((this.viewrangeGene+this.hungerGene+this.thirstGene+this.matingGene+this.healthGene)*2),this.hunger=0,this.thirst=0,this.matingUrge=0,this.sickness=0,this.FOOD=null,this.WATER=null,this.MATE=null,this.CHILDREN=[],this.lastFood=null,this.lastWater=null}update(){this.move(),this.handleNeeds(),this.handleAge(),this.handleSickness(),this.communicate(),this.draw()}draw(){this.settings.viewrange&&(this.surface.beginPath(),this.surface.arc(this.posX,this.posY,this.viewrange,0,Math.PI*2),this.surface.fillStyle="rgba(255, 255, 255, 0.1)",this.surface.strokeStyle="rgba(255, 255, 255, 0.5)",this.surface.fill(),this.surface.stroke()),this.settings.hud&&(this.surface.beginPath(),this.surface.fillStyle=this.isSick?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.2)",this.surface.fillRect(this.posX-25,this.posY-this.size-24,50,12),this.surface.beginPath(),this.surface.fillStyle="rgba(250, 128, 52, 1)",this.surface.fillRect(this.posX-25,this.posY-this.size-24,this.hunger/2,3),this.surface.beginPath(),this.surface.fillStyle="rgba(110, 245, 255, 1)",this.surface.fillRect(this.posX-25,this.posY-this.size-21,this.thirst/2,3),this.surface.beginPath(),this.surface.fillStyle="rgba(247, 54, 151, 1)",this.surface.fillRect(this.posX-25,this.posY-this.size-18,this.matingUrge/2,3),this.surface.beginPath(),this.surface.fillStyle="rgba(64, 255, 54, 1)",this.surface.fillRect(this.posX-25,this.posY-this.size-15,this.sickness/2,3),this.surface.font="1rem Arial",this.surface.fillStyle="black",this.surface.textAlign="center",this.surface.fillText(`${this.atractivity} ${this.status}  ${Math.floor(this.age)}`,this.posX,this.posY+this.size*2+10)),this.surface.beginPath(),this.surface.arc(this.posX,this.posY,this.size,0,Math.PI*2),this.surface.fillStyle=this.isPregnant?this.pregnantColor:this.color,this.surface.fill(),this.settings.dot&&(this.surface.beginPath(),this.surface.arc(this.destX,this.destY,1,0,Math.PI*2),this.surface.fillStyle="yellow",this.surface.fill())}move(){if(!this.isWaiting){var t=+Math.hypot(this.posX-this.destX,this.posY-this.destY),i=Math.atan2(this.destY-this.posY,this.destX-this.posX),s=Math.cos(i)*this.speed,e=Math.sin(i)*this.speed;t>1&&!this.waterCheck()?(this.posX+=s,this.posY+=e):this.randomDestination()}}waterCheck(){if(this.WATER==null){for(let t of this.data.water)if(this.destX<=t.posX+t.size&&this.destY<=t.posY+t.size&&this.destX>=t.posX&&this.destY>=t.posY)return!0}return!1}randomDestination(){let t=this.posX+(Math.random()*(this.viewrange+this.viewrange)-this.viewrange),i=this.posY+(Math.random()*(this.viewrange+this.viewrange)-this.viewrange);t>this.settings.width&&(t=this.settings.width),t<0&&(t=0),i>this.settings.height&&(i=this.settings.height),i<0&&(i=0),this.destX=t,this.destY=i,this.status="Wandering"}handleNeeds(){this.hunger+=(1-this.hungerGene)/10,this.thirst+=(1-this.thirstGene)/10,this.isAdult&&(this.matingUrge+=Math.sqrt(this.matingGene)/(this.age/15)/10),this.hunger>100&&(this.hunger=100,this.isAlive=!1),this.thirst>100&&(this.thirst=100,this.isAlive=!1),this.matingUrge>100&&(this.matingUrge=100),this.hunger<0&&(this.hunger=0),this.thirst<0&&(this.thirst=0),this.matingUrge<0&&(this.matingUrge=0),this.isEating&&(this.hunger-=1),this.isDrinking&&(this.thirst-=1),this.isMating&&(this.matingUrge-=.7),this.findFood(),this.goEat(),this.findWater(),this.goDrink(),this.goMate()}findFood(){if(this.hunger>50&&this.isEating==!1){let t=this.data.foodmap[0],i=1e4;for(let s of this.data.foodmap)if(!s.isEaten){let e=Math.hypot(this.posX-s.posX,this.posY-s.posY);e<i&&(i=e,t=s)}if(i<=this.viewrange+this.size){this.FOOD=t;return}}this.hunger>=75&&this.FOOD==null&&this.lastFood!=null&&(this.lastFood.isEaten||(this.FOOD=this.lastFood))}goEat(){if(this.FOOD&&!this.FOOD.isEaten){this.destX=this.FOOD.posX,this.destY=this.FOOD.posY;let t=Math.hypot(this.posX-this.FOOD.posX,this.posY-this.FOOD.posY);this.status="Going to eat",t<1&&(this.lastFood=this.FOOD,this.FOOD.getEaten(),this.FOOD=null,this.isEating=!0,this.status="Eating",this.wait(2e3),this.getSick(2))}this.FOOD&&this.FOOD.isEaten&&(this.FOOD=null)}findWater(){if(this.thirst>50&&this.isDrinking==!1){let t=this.data.water[0],i=1e4;for(let s of this.data.water){let e=Math.hypot(this.posX-s.posX,this.posY-s.posY);e<i&&(i=e,t=s)}if(i<=this.viewrange+this.size){this.WATER=t;return}}this.thirst>=70&&this.WATER==null&&this.lastWater!=null&&(this.WATER=this.lastWater)}goDrink(){if(this.WATER){let t=this.WATER.posX+this.WATER.size/2,i=this.WATER.posY+this.WATER.size/2;this.destX=t,this.destY=i;let s=Math.hypot(this.posX-t,this.posY-i);this.status="Going to drink",s<1&&(this.lastWater=this.WATER,this.WATER=null,this.isDrinking=!0,this.status="Drinking",this.wait(2e3),this.getSick(3))}}goMate(){if(this.MATE){this.destX=this.MATE.posX,this.destY=this.MATE.posY;let t=Math.hypot(this.posX-this.destX,this.posY-this.destY);this.status="Going to mate",t<1&&(this.status="Mating",this.isMating=!0,this.wait(2e3),this.gender=="F"?this.getPregnant(this.MATE):this.MATE.getPregnant(this),this.MATE=null)}}answearMatingRequest(t){return this.matingUrge>=100-this.settings.mating*t.atractivity}getPregnant(t){if(!this.isPregnant){let i=Math.random(),s=Math.random(),e=1;if(i>.6){this.isPregnant=!0,s<.2&&(e=2),s<.08&&(e=3);const h=setTimeout(()=>{for(let r=0;r<e;r++){let n=Math.random()>=.5?"M":"F";this.CHILDREN.push(new v(n,this.settings,this.surface,t,this,this.data,this.population))}this.isPregnant=!1,clearTimeout(h)},this.settings.pregnancyDuration)}}}handleAge(){if(this.age+=.004,this.age>=15&&(this.isAdult=!0),this.isAdult&&(this.size=this.adultSize),Math.floor(this.age)>this.prevAge){let t=Math.random(),i=this.age/100/(100-this.sickness/5-this.age);t<=i&&(this.isAlive=!1,console.log("Died at age:"+this.age)),this.prevAge=Math.floor(this.age)}}handleSickness(){if(this.isSick){this.sickness+=(1-this.healthGene)/10,this.sickness>100&&(this.sickness=100,this.isAlive=!1);for(let i of this.population)Math.hypot(this.posX-i.posX,this.posY-i.posY)<=this.size*5+this.size&&i.getSick(40);let t=Math.random();console.log(t),t<this.sickness/1e5&&(this.isSick=!1,this.sickness=0)}}getSick(t){this.age-this.lastGotSick>=2&&Math.random()<this.healthGene*t/100&&(this.isSick=!0,this.lastGotSick=this.age)}communicate(){for(let t of this.population)if(Math.hypot(this.posX-t.posX,this.posY-t.posY)<=this.viewrange+this.size&&(this.lastFood==null&&(this.lastFood=t.lastFood),this.lastWater==null&&(this.lastWater=t.lastWater),t.gender!=this.gender)){let s=this.answearMatingRequest(t),e=t.answearMatingRequest(this);s&&e&&(this.MATE=t,t.MATE=this)}}wait(t){this.isWaiting=!0;const i=setTimeout(()=>{this.isWaiting=!1,this.isMating=!1,this.isEating=!1,this.isDrinking=!1,clearTimeout(i)},t)}}class E{constructor(t,i){this.settings=t,this.data=i,this.posX=0,this.posY=0,this.createSpawnPositions(),this.type="RandomParent",this.speed=Math.random()*(1.2-.8)+.8,this.viewrangeGene=Math.random(),this.hungerGene=Math.random(),this.thirstGene=Math.random(),this.matingGene=Math.random(),this.healthGene=Math.random()}createSpawnPositions(){let t=this.data.terrain.filter(s=>s.type=="ground"),i=Math.floor(Math.random()*t.length);this.posX=t[i].posX+t[i].size,this.posY=t[i].posY+t[i].size}}class C{constructor(t,i,s){this.surface=t,this.settings=i,this.data=s,this.population=[],this.createPopulation(),this.maleAddButton=document.querySelector("#addMale").addEventListener("click",()=>{this.addMale()}),this.femaleAddButton=document.querySelector("#addFemale").addEventListener("click",()=>{this.addFemale()}),this.clearButton=document.querySelector("#clearPop").addEventListener("click",()=>{this.population=[]})}update(){return this.population=this.population.filter(t=>t.isAlive),this.population.forEach(t=>{t.update(),t.CHILDREN.length>0&&(this.population=this.population.concat(t.CHILDREN),t.CHILDREN=[],t.isPregnant=!1)}),this.population}createPopulation(){for(let t=0;t<this.settings.male;t++){const i=new E(this.settings,this.data);this.population.push(new v("M",this.settings,this.surface,i,i,this.data,this.population))}for(let t=0;t<this.settings.female;t++){const i=new E(this.settings,this.data);this.population.push(new v("F",this.settings,this.surface,i,i,this.data,this.population))}}addMale(){const t=new E(this.settings,this.data);this.population.push(new v("M",this.settings,this.surface,t,t,this.data,this.population)),console.log("Male created")}addFemale(){const t=new E(this.settings,this.data);this.population.push(new v("F",this.settings,this.surface,t,t,this.data,this.population))}}class K{constructor(t,i){this.isOpen=!1,this.WIDTH=t,this.HEIGHT=i,this.populationText=document.querySelector("#population"),this.maleText=document.querySelector("#male"),this.femaleText=document.querySelector("#female"),this.settingsButton=document.querySelector("#settingsBtn").addEventListener("click",()=>{this.toggleSettings()}),this.settingsDiv=document.querySelector(".settings"),this.screen=document.querySelector(".screen"),this.foodDensity=document.querySelector("#food").value=15,this.waterDensity=document.querySelector("#water").value=40,this.matingFrequency=document.querySelector("#mating").value=20,this.viewrange=document.querySelector("#viewrange").checked=!1,this.hud=document.querySelector("#hud").checked=!0,this.destination=document.querySelector("#destination").checked=!1,this.maleNum=document.querySelector("#malesCount").value=10,this.femaleNum=document.querySelector("#femalesCount").value=10,this.worldSize=document.querySelector("#worldSize").value=this.defaultSize()}update(t){let i=t.length,s=t.filter(e=>e.gender=="M").length;this.populationText.innerText=`Population: ${i}`,this.maleText.innerText=`Males: ${s}`,this.femaleText.innerText=`Females: ${i-s}`}toggleSettings(){this.isOpen?(this.isOpen=!1,this.settingsDiv.classList.add("hidden")):(this.isOpen=!0,this.settingsDiv.classList.remove("hidden"))}getSettings(){return this.foodDensity=document.querySelector("#food").value,this.waterDensity=document.querySelector("#water").value,this.matingFrequency=document.querySelector("#mating").value,this.viewrange=document.querySelector("#viewrange").checked,this.hud=document.querySelector("#hud").checked,this.destination=document.querySelector("#destination").checked,this.maleNum=document.querySelector("#malesCount").value,this.femaleNum=document.querySelector("#femalesCount").value,this.worldSize=+document.querySelector("#worldSize").value,{width:this.WIDTH,height:this.HEIGHT,food:this.foodDensity/100,water:this.waterDensity/100,mating:this.matingFrequency/10,x:this.worldSize,male:this.maleNum,female:this.femaleNum,viewrange:this.viewrange,hud:this.hud,dot:this.destination,pregnancyDuration:15e3}}defaultSize(){return this.WIDTH<=460?24:this.WIDTH<=724?32:this.WIDTH<=1100?48:64}}const M=document.querySelector(".canvas"),y=M.getContext("2d"),N=document.querySelector("#app").getBoundingClientRect();M.width=N.width;M.height=N.height;var j=M.width,J=M.height,P=new K(j,J),m=P.getSettings(),g=new H(y,m),G=new b(y,m,g.GRID),F={terrain:g.GRID,water:g.WATER,foodmap:G.FOOD},z=[],L=new C(y,m,F);document.querySelector("#applySettings").addEventListener("click",()=>{Q()});function Q(){m=P.getSettings(),g=new H(y,m),G=new b(y,m,g.GRID),F={terrain:g.GRID,water:g.WATER,foodmap:G.FOOD},z=[],L=new C(y,m,F)}function x(){g.update(),G.update(),z=L.update(),P.update(z),window.requestAnimationFrame(x)}x();
